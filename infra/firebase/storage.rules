rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ==================== Helper Functions ====================

    function isAuthenticated() {
      return request.auth != null;
    }

    function userId() {
      return request.auth.uid;
    }

    function isStoreOwner(storeId) {
      return isAuthenticated() &&
        firestore.exists(/databases/(default)/documents/stores/$(storeId)) &&
        firestore.get(/databases/(default)/documents/stores/$(storeId)).data.ownerId == userId();
    }

    function isValidSize() {
      return request.resource.size < 50 * 1024 * 1024;
    }

    function isImage() {
      return request.resource.contentType.matches('image/(jpeg|png|webp|gif)');
    }

    // ==================== Store Assets ====================
    // Path: stores/{storeId}/{category}/{resourceId}/{filename}

    match /stores/{storeId}/{category}/{resourceId}/{filename} {
      allow read: if isStoreOwner(storeId);

      allow write: if isStoreOwner(storeId) &&
        isValidSize() &&
        isImage();

      allow delete: if isStoreOwner(storeId);
    }

    // ==================== Deny All Other Paths ====================

    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
