rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ==================== Helper Functions ====================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get the current user's ID
    function userId() {
      return request.auth.uid;
    }

    // Check if the user owns a store
    function isStoreOwner(storeId) {
      return isAuthenticated() &&
        firestore.exists(/databases/(default)/documents/stores/$(storeId)) &&
        firestore.get(/databases/(default)/documents/stores/$(storeId)).data.ownerId == userId();
    }

    // Validate file size (max 50MB)
    function isValidSize() {
      return request.resource.size < 50 * 1024 * 1024;
    }

    // Validate image content type
    function isImage() {
      return request.resource.contentType.matches('image/(jpeg|png|webp)');
    }

    // ==================== Store Assets ====================
    // Path format: {storeId}/{category}/{assetId}/{filename}

    match /{storeId}/{category}/{assetId}/{filename} {

      // Read: Allow if user owns the store OR if the file is publicly accessible
      // Public access is controlled by setting custom metadata
      allow read: if isStoreOwner(storeId) ||
        (resource != null && resource.metadata.public == 'true');

      // Write: Allow if user owns the store and file meets requirements
      allow write: if isStoreOwner(storeId) &&
        isValidSize() &&
        isImage();

      // Delete: Allow if user owns the store
      allow delete: if isStoreOwner(storeId);
    }

    // ==================== Signed URL Uploads ====================
    // Allow uploads via signed URLs (created by Cloud Functions)
    // The signed URL contains the necessary authentication

    match /{storeId}/{category}/{assetId}/{filename} {
      // Cloud Functions use admin SDK which bypasses rules
      // This rule allows the upload if the request has the correct token
      allow write: if request.auth != null &&
        isValidSize() &&
        isImage();
    }

    // ==================== Public CDN Access ====================
    // Generated images can be accessed publicly via CDN

    match /{storeId}/generated/{assetId}/{filename} {
      // Allow public read for generated images (for sharing)
      allow read: if true;
    }

    // ==================== Thumbnail Access ====================

    match /{storeId}/{category}/{assetId}/thumbnails/{thumbnailName} {
      // Allow read if user owns the store or the parent is public
      allow read: if isStoreOwner(storeId) ||
        (resource != null && resource.metadata.public == 'true');
    }
  }
}
